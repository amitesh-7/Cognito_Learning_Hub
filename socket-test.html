<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Test - QuizWise AI</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
    }
    .connected { background: rgba(76, 175, 80, 0.5); }
    .error { background: rgba(244, 67, 54, 0.5); }
    button {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    input {
      padding: 10px;
      border: none;
      border-radius: 5px;
      width: 100%;
      margin: 10px 0;
      font-size: 14px;
    }
    .log {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4CAF50;
      padding-left: 10px;
    }
    .log-error {
      border-left-color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîå Socket.IO Connection Test</h1>
    
    <div id="connectionStatus" class="status">
      Status: <span id="statusText">Not Connected</span>
    </div>

    <div style="margin: 20px 0;">
      <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:3001">
      <button onclick="connectToServer()">Connect to Server</button>
      <button onclick="disconnectFromServer()" id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div style="margin: 20px 0;">
      <h3>Test Session Creation</h3>
      <input type="text" id="quizId" placeholder="Quiz ID (MongoDB ObjectId)">
      <input type="text" id="hostId" placeholder="Host ID (MongoDB ObjectId)">
      <button onclick="createSession()" id="createBtn" disabled>Create Test Session</button>
    </div>

    <div style="margin: 20px 0;">
      <h3>Test Session Join</h3>
      <input type="text" id="sessionCode" placeholder="Session Code (6 chars)">
      <input type="text" id="userId" placeholder="User ID">
      <input type="text" id="username" placeholder="Username">
      <button onclick="joinSession()" id="joinBtn" disabled>Join Session</button>
    </div>

    <div class="log" id="eventLog">
      <div class="log-entry">Waiting for connection...</div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    let socket = null;

    function log(message, isError = false) {
      const logDiv = document.getElementById('eventLog');
      const entry = document.createElement('div');
      entry.className = 'log-entry' + (isError ? ' log-error' : '');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(text, isConnected) {
      const statusDiv = document.getElementById('connectionStatus');
      const statusText = document.getElementById('statusText');
      statusText.textContent = text;
      statusDiv.className = 'status ' + (isConnected ? 'connected' : 'error');
      
      // Enable/disable buttons
      document.getElementById('disconnectBtn').disabled = !isConnected;
      document.getElementById('createBtn').disabled = !isConnected;
      document.getElementById('joinBtn').disabled = !isConnected;
    }

    function connectToServer() {
      const serverUrl = document.getElementById('serverUrl').value;
      
      if (socket) {
        log('Already connected. Disconnect first.', true);
        return;
      }

      log(`Attempting to connect to ${serverUrl}...`);
      
      socket = io(serverUrl, {
        transports: ['websocket', 'polling']
      });

      socket.on('connect', () => {
        log(`‚úÖ Connected! Socket ID: ${socket.id}`);
        updateStatus('Connected', true);
      });

      socket.on('disconnect', (reason) => {
        log(`‚ùå Disconnected. Reason: ${reason}`, true);
        updateStatus('Disconnected', false);
        socket = null;
      });

      socket.on('connect_error', (error) => {
        log(`‚ùå Connection error: ${error.message}`, true);
        updateStatus('Connection Failed', false);
      });

      // Listen for session events
      socket.on('participant-joined', (data) => {
        log(`üë§ Participant joined: ${data.username} (Total: ${data.participantCount})`);
      });

      socket.on('quiz-started', (data) => {
        log(`üéØ Quiz started! Question ${data.questionIndex + 1}/${data.totalQuestions}`);
        log(`   Question: "${data.question.question}"`);
      });

      socket.on('leaderboard-updated', (data) => {
        log(`üèÜ Leaderboard updated (Question ${data.questionIndex + 1})`);
        if (data.leaderboard && data.leaderboard.length > 0) {
          log(`   Top: ${data.leaderboard[0].username} - ${data.leaderboard[0].score} pts`);
        }
      });

      socket.on('session-ended', (data) => {
        log(`üèÅ Session ended! Total participants: ${data.totalParticipants}`);
      });

      socket.on('host-disconnected', (data) => {
        log(`‚ö†Ô∏è ${data.message}`, true);
      });
    }

    function disconnectFromServer() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('Disconnected manually');
        updateStatus('Disconnected', false);
      }
    }

    function createSession() {
      if (!socket) {
        log('Not connected to server', true);
        return;
      }

      const quizId = document.getElementById('quizId').value;
      const hostId = document.getElementById('hostId').value;

      if (!quizId || !hostId) {
        log('Please provide Quiz ID and Host ID', true);
        return;
      }

      log('Creating session...');

      socket.emit('create-session', {
        quizId,
        hostId,
        settings: {
          timePerQuestion: 30,
          showLeaderboardAfterEach: true,
          allowLateJoin: false,
          maxParticipants: 100
        }
      }, (response) => {
        if (response.success) {
          log(`‚úÖ Session created! Code: ${response.sessionCode}`);
          log(`   Session ID: ${response.sessionId}`);
          document.getElementById('sessionCode').value = response.sessionCode;
        } else {
          log(`‚ùå Failed to create session: ${response.error}`, true);
        }
      });
    }

    function joinSession() {
      if (!socket) {
        log('Not connected to server', true);
        return;
      }

      const sessionCode = document.getElementById('sessionCode').value.toUpperCase();
      const userId = document.getElementById('userId').value;
      const username = document.getElementById('username').value;

      if (!sessionCode || !userId || !username) {
        log('Please provide Session Code, User ID, and Username', true);
        return;
      }

      log(`Joining session ${sessionCode}...`);

      socket.emit('join-session', {
        sessionCode,
        userId,
        username,
        avatar: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(username)
      }, (response) => {
        if (response.success) {
          log(`‚úÖ Joined session: ${response.session.quizTitle}`);
          log(`   Status: ${response.session.status}`);
          log(`   Participants: ${response.session.participantCount}`);
        } else {
          log(`‚ùå Failed to join: ${response.error}`, true);
        }
      });
    }

    // Auto-connect on page load (optional)
    // setTimeout(connectToServer, 500);
  </script>
</body>
</html>
